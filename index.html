<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <style>
        .chart-container {
            width: 80%;
            height: 300px;
            margin: auto;
        }
    </style>
</head>
<body>
    <h3>General System and PID Controller</h3>
    <p>The system transfer function:</p>
    <p> $$H(s) = \frac{b_0 s^m + b_1 s^{m-1} + \dots + b_m}{s^n + a_1 s^{n-1} + \dots + a_n}$$</p>
    <p>The PID controller:</p>
    <p>$$u(t) = K_pe(t) + K_i \int_0^t e(r) \mathrm dr + K_d \frac{de(t)}{dt} $$</p>

    <h3>PID Controller Simulation</h3>
    <form id="pidForm">
        <fieldset>
            <legend>System Parameters</legend>
            <label for="num_coeff">Numerator Coefficients (comma-separated):</label>
            <input type="text" id="num_coeff" value="1,0,2">
            <label for="den_coeff">Denominator Coefficients (comma-separated):</label>
            <input type="text" id="den_coeff" value="1,3,2">
        </fieldset>
        <fieldset>
            <legend>PID Gains</legend>
            <label for="kp">Proportional (\(K_p\)):</label>
            <input type="number" step="0.1" id="kp" value="1">
            <label for="ki">Integral (\(K_i\)):</label>
            <input type="number" step="0.1" id="ki" value="0">
            <label for="kd">Derivative (\(K_d\)):</label>
            <input type="number" step="0.1" id="kd" value="0">
        </fieldset>
        <fieldset>
            <legend>Simulation Settings</legend>
            <label for="duration">Duration (sec):</label>
            <input type="number" step="1" id="duration" value="10">
            <label for="dt">Time Step (sec):</label>
            <input type="number" step="0.001" id="dt" value="0.01">
            <label for="setpoint">Setpoint:</label>
            <input type="number" step="0.1" id="setpoint" value="1"><br/>
            <label for="saturation">Saturation on (\(u\)):</label>
            <input type="number" step="0.1" id="saturation" value="1">
        </fieldset>
        <button type="button" onclick="simulate()">Run Simulation</button>
    </form>

    <div class="chart-container">
        <canvas id="outputPlot"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="controlPlot"></canvas>
    </div>

    <script>
        let chartInstance1 = null;
        let chartInstance2 = null;

        function simulate() {
            const num_coeff = document.getElementById("num_coeff").value.split(",").map(Number);
            const den_coeff = document.getElementById("den_coeff").value.split(",").map(Number);
            const Kp = parseFloat(document.getElementById("kp").value);
            const Ki = parseFloat(document.getElementById("ki").value);
            const Kd = parseFloat(document.getElementById("kd").value);
            const duration = parseFloat(document.getElementById("duration").value);
            const dt = parseFloat(document.getElementById("dt").value);
            const setpoint = parseFloat(document.getElementById("setpoint").value);
            const saturation = parseFloat(document.getElementById("saturation").value);

            const n = den_coeff.length - 1; // Order of denominator
            const m = num_coeff.length - 1; // Order of numerator

            const time = [];
            const output = [];
            const controlSignal = [];

            let x = Array(n).fill(0); // State variables
            let u = 0;
            let u_derivatives = Array(m + 1).fill(0); // Track u, u', u'', ...
            let integral = 0;
            let previousError = setpoint;

            for (let t = 0; t <= duration; t += dt) {
                time.push(t.toFixed(2));

                // PID Control Law
                const error = setpoint - x[0];
                integral += error * dt;
                const derivative = (error - previousError) / dt;
                let newU = Kp * error + Ki * integral + Kd * derivative;
                newU = Math.max(-saturation, Math.min(saturation, newU)); // Apply saturation
                controlSignal.push(newU);

                // Compute derivatives of u
                u_derivatives.unshift((newU - u_derivatives[0]) / dt);
                u_derivatives.pop(); // Keep only m+1 elements
                u = newU;

                // Compute state derivatives using system dynamics
                let dx = Array(n).fill(0);
                for (let i = 0; i < n - 1; i++) {
                    dx[i] = x[i + 1]; // Shift state variables
                }

                // Compute system equation
                let sumA = den_coeff.slice(1).reduce((sum, coef, i) => sum + coef * x[i], 0);
                let sumB = num_coeff.reduce((sum, coef, j) => sum + coef * u_derivatives[j], 0);
                dx[n - 1] = -sumA + sumB;

                // Update system states
                for (let i = 0; i < n; i++) {
                    x[i] += dx[i] * dt;
                }
                output.push(x[0]);

                // Update previous values
                previousError = error;
            }

            plotData(time, output, setpoint, controlSignal, saturation);
        }

        function plotData(time, output, setpoint, controlSignal, saturation) {
            // (Plotting logic remains the same)
        }
    </script>
</body>
</html>
